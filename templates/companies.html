{% extends "base.html" %}

{% block title %}Empresas - Hotspot Manager{% endblock %}

{% block body %}
<div class="container">
  <aside class="sidebar">
      <div class="logo">
          <div class="logo-icon">MT</div>
          <div class="logo-text">
              <h2>Hotspot Manager</h2>
              <p>Sistema de Gestão</p>
          </div>
      </div>
      <nav>
          <ul class="nav-menu">
              <li class="nav-item">
                  <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('users') }}" class="nav-link">Usuários</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('companies') }}" class="nav-link active">Empresas</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('profiles') }}" class="nav-link">Perfis Hotspot</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('hotspot_users') }}" class="nav-link">Usuários Hotspot</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('credits') }}" class="nav-link">Créditos</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('reports') }}" class="nav-link">Relatórios</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('mikrotik_logs') }}" class="nav-link">Logs MikroTik</a>
              </li>
              <li class="nav-item">
                  <a href="{{ url_for('settings') }}" class="nav-link">Configurações</a>
              </li>
          </ul>
      </nav>
  </aside>

  <main class="main-content">
      <div class="header">
          <div>
              <h1>Gerenciamento de Empresas</h1>
              <p>Gerencie empresas e suas configurações MikroTik</p>
          </div>
          <div class="user-info">
              <span class="user-name">{{ user.name }}</span>
              <a href="{{ url_for('logout') }}" class="logout-btn">Sair</a>
          </div>
      </div>

      <style>
          .action-bar {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 1.5rem;
              background: white;
              padding: 1rem;
              border-radius: 8px;
              box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          }
          .companies-grid {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
              gap: 1.5rem;
              margin-bottom: 2rem;
          }
          .company-card {
              background: white;
              border-radius: 8px;
              box-shadow: 0 1px 3px rgba(0,0,0,0.1);
              padding: 1.5rem;
              transition: transform 0.2s;
          }
          .company-card:hover {
              transform: translateY(-2px);
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          .company-name {
              font-size: 1.25rem;
              font-weight: 600;
              color: #1f2937;
              margin-bottom: 1rem;
          }
          .company-info {
              margin-bottom: 1rem;
          }
          .info-item {
              display: flex;
              justify-content: space-between;
              margin-bottom: 0.5rem;
              font-size: 0.875rem;
          }
          .info-label {
              color: #6b7280;
          }
          .info-value {
              color: #1f2937;
              font-weight: 500;
          }
          .company-actions {
              display: flex;
              gap: 0.5rem;
              margin-top: 1rem;
              flex-wrap: wrap;
          }
          .btn-action {
              padding: 0.5rem;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 0.875rem;
              display: flex;
              align-items: center;
              gap: 0.25rem;
              flex: 1;
              min-width: 80px;
              justify-content: center;
          }
          .btn-test {
              background: #3b82f6;
              color: white;
          }
          .btn-sync {
              background: #10b981;
              color: white;
          }
          .btn-import {
              background: #06b6d4;
              color: white;
          }
          .btn-usage {
              background: #f59e0b;
              color: white;
          }
          .btn-edit {
              background: #8b5cf6;
              color: white;
          }
          .btn-action:hover {
              opacity: 0.8;
          }
          .add-company-card {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              text-align: center;
              cursor: pointer;
              transition: transform 0.2s;
          }
          .add-company-card:hover {
              transform: translateY(-2px);
          }
          .add-icon {
              font-size: 3rem;
              margin-bottom: 1rem;
              opacity: 0.8;
          }
          .modal {
              display: none;
              position: fixed;
              z-index: 1000;
              left: 0;
              top: 0;
              width: 100%;
              height: 100%;
              background-color: rgba(0,0,0,0.5);
          }
          .modal-content {
              background-color: white;
              margin: 5% auto;
              padding: 2rem;
              border-radius: 8px;
              width: 90%;
              max-width: 500px;
          }
          .form-group {
              margin-bottom: 1rem;
          }
          .form-label {
              display: block;
              margin-bottom: 0.5rem;
              font-weight: 500;
          }
          .form-input, .form-select {
              width: 100%;
              padding: 0.75rem;
              border: 1px solid #d1d5db;
              border-radius: 6px;
              font-size: 0.875rem;
          }
          .form-actions {
              display: flex;
              gap: 1rem;
              justify-content: flex-end;
              margin-top: 1.5rem;
          }
          .btn-primary {
              background: #3b82f6;
              color: white;
              border: none;
              padding: 0.75rem 1.5rem;
              border-radius: 6px;
              cursor: pointer;
          }
          .btn-secondary {
              background: #6b7280;
              color: white;
              border: none;
              padding: 0.75rem 1.5rem;
              border-radius: 6px;
              cursor: pointer;
          }
          .status-badge {
              padding: 0.25rem 0.5rem;
              border-radius: 4px;
              font-size: 0.75rem;
              font-weight: 500;
              margin-top: 0.5rem;
              display: inline-block;
          }
          .status-connected {
              background: #d1fae5;
              color: #065f46;
          }
          .status-disconnected {
              background: #fee2e2;
              color: #991b1b;
          }
          .status-testing {
              background: #fef3c7;
              color: #92400e;
          }
          .turma-control {
              margin-top: 1rem;
              padding: 1rem;
              background: #f9fafb;
              border-radius: 6px;
              border: 1px solid #e5e7eb;
          }
          .turma-label {
              font-size: 0.875rem;
              font-weight: 500;
              color: #374151;
              margin-bottom: 0.5rem;
          }
          .turma-select {
              width: 100%;
              padding: 0.5rem;
              border: 1px solid #d1d5db;
              border-radius: 4px;
              font-size: 0.875rem;
              margin-bottom: 0.5rem;
          }
          .turma-btn {
              background: #f59e0b;
              color: white;
              border: none;
              padding: 0.5rem 1rem;
              border-radius: 4px;
              cursor: pointer;
              font-size: 0.875rem;
              width: 100%;
          }
          .turma-btn:hover {
              background: #d97706;
          }
          .collect-all-btn {
              background: #06b6d4;
              color: white;
              border: none;
              padding: 0.75rem 1.5rem;
              border-radius: 6px;
              cursor: pointer;
              margin-left: 1rem;
          }
      </style>

      <!-- Flash Messages -->
      {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
              {% for category, message in messages %}
                  <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' }}" style="background: {{ '#fee2e2' if category == 'error' else '#d1fae5' if category == 'success' else '#fef3c7' if category == 'warning' else '#dbeafe' }}; color: {{ '#991b1b' if category == 'error' else '#065f46' if category == 'success' else '#92400e' if category == 'warning' else '#1e40af' }}; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                      {{ message }}
                  </div>
              {% endfor %}
          {% endif %}
      {% endwith %}

      <div class="action-bar">
          <h2>Lista de Empresas</h2>
          <div>
              <button class="btn-primary" onclick="openModal()">+ Nova Empresa</button>
              <form method="post" action="/collect-all-usage" style="display: inline;">
                  <button type="submit" class="collect-all-btn">Coletar Uso Geral</button>
              </form>
          </div>
      </div>

      <div class="companies-grid">
          {% for company in companies_list %}
          <div class="company-card">
              <div class="company-name">{{ company.name }}</div>
              <div class="company-info">
                  <div class="info-item">
                      <span class="info-label">IP do Roteador:</span>
                      <span class="info-value">{{ company.mikrotik_ip }}:{{ company.mikrotik_port }}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Usuário:</span>
                      <span class="info-value">{{ company.mikrotik_user }}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Usuários Ativos:</span>
                      <span class="info-value">{{ company.user_count or 0 }}</span>
                  </div>
                  <div class="info-item">
                      <span class="info-label">Turma Ativa:</span>
                      <span class="info-value">Turma {{ company.turma_ativa }}</span>
                  </div>
              </div>
              
              <div class="turma-control">
                  <div class="turma-label">Controle de Turma:</div>
                  <form method="POST" action="/companies/update-turma" style="margin: 0;">
                      <input type="hidden" name="company_id" value="{{ company.id }}">
                      <select name="turma_ativa" class="turma-select">
                          <option value="A" {% if company.turma_ativa == 'A' %}selected{% endif %}>Turma A</option>
                          <option value="B" {% if company.turma_ativa == 'B' %}selected{% endif %}>Turma B</option>
                      </select>
                      <button type="submit" class="turma-btn">Alterar Turma Ativa</button>
                  </form>
              </div>
              
              <span class="status-badge status-{{ 'connected' if company.connection_status == 'connected' else 'disconnected' }}">
                  {{ 'Conectado' if company.connection_status == 'connected' else 'Desconectado' }}
              </span>

              <div class="company-actions">
                  <form method="post" action="/companies/{{ company.id }}/test-connection" style="display: inline; flex: 1;">
                      <button type="submit" class="btn-action btn-test" title="Testar Conexão">
                          🔌 Testar
                      </button>
                  </form>
                  
                  <form method="post" action="/companies/{{ company.id }}/sync-users" style="display: inline; flex: 1;">
                      <button type="submit" class="btn-action btn-sync" title="Sincronizar">
                          🔄 Sincronizar
                      </button>
                  </form>
                  
                  <form method="post" action="/companies/{{ company.id }}/import-users" style="display: inline; flex: 1;">
                      <button type="submit" class="btn-action btn-import" title="Importar">
                          📥 Importar
                      </button>
                  </form>
                  
                  <form method="post" action="/companies/{{ company.id }}/collect-usage" style="display: inline; flex: 1;">
                      <button type="submit" class="btn-action btn-usage" title="Coletar Uso">
                          📊 Coletar Uso
                      </button>
                  </form>
                  
                  <button class="btn-action btn-edit" onclick="editCompany('{{ company.id }}', '{{ company.name }}', '{{ company.mikrotik_ip }}', '{{ company.mikrotik_port }}', '{{ company.mikrotik_user }}', '{{ company.mikrotik_password }}', '{{ company.turma_ativa }}')" title="Editar">
                      ✏️ Editar
                  </button>
              </div>
          </div>
          {% else %}
          <div class="company-card add-company-card" onclick="openModal()">
              <div class="add-icon">+</div>
              <h3>Adicionar Nova Empresa</h3>
              <p>Clique para cadastrar uma nova empresa</p>
          </div>
          {% endfor %}
      </div>

      <!-- Modal de Cadastro/Edição -->
      <div id="companyModal" class="modal">
          <div class="modal-content">
              <h3 id="modalTitle">Cadastrar Nova Empresa</h3>
              <form id="companyForm" method="POST">
                  <input type="hidden" id="companyId" name="id">
                  <div class="form-group">
                      <label class="form-label">Nome da Empresa</label>
                      <input type="text" id="companyName" name="name" class="form-input" required>
                  </div>
                  <div class="form-group">
                      <label class="form-label">IP do MikroTik</label>
                      <input type="text" id="companyIp" name="mikrotik_ip" class="form-input" placeholder="192.168.1.1" required>
                  </div>
                  <div class="form-group">
                      <label class="form-label">Porta SSH</label>
                      <input type="number" id="companyPort" name="mikrotik_port" class="form-input" value="22" required>
                  </div>
                  <div class="form-group">
                      <label class="form-label">Usuário SSH</label>
                      <input type="text" id="companyUser" name="mikrotik_user" class="form-input" required>
                  </div>
                  <div class="form-group">
                      <label class="form-label">Senha SSH</label>
                      <input type="password" id="companyPassword" name="mikrotik_password" class="form-input" required>
                  </div>
                  <div class="form-group">
                      <label class="form-label">Turma Ativa</label>
                      <select name="turma_ativa" id="companyTurma" class="form-select" required>
                          <option value="A">Turma A</option>
                          <option value="B">Turma B</option>
                      </select>
                  </div>
                  <div class="form-actions">
                      <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                      <button type="submit" class="btn-primary" id="submitBtn">Cadastrar</button>
                  </div>
              </form>
          </div>
      </div>

      <script>
          function openModal() {
              document.getElementById('companyModal').style.display = 'block';
              document.getElementById('modalTitle').textContent = 'Cadastrar Nova Empresa';
              document.getElementById('companyForm').action = '/companies';
              document.getElementById('submitBtn').textContent = 'Cadastrar';
              document.getElementById('companyForm').reset();
              document.getElementById('companyId').value = '';
          }

          function closeModal() {
              document.getElementById('companyModal').style.display = 'none';
          }

          function editCompany(id, name, ip, port, user, password, turma) {
              document.getElementById('companyModal').style.display = 'block';
              document.getElementById('modalTitle').textContent = 'Editar Empresa';
              document.getElementById('companyForm').action = '/companies/' + id + '/edit';
              document.getElementById('submitBtn').textContent = 'Atualizar';
              
              // Preencher campos
              document.getElementById('companyName').value = name;
              document.getElementById('companyIp').value = ip;
              document.getElementById('companyPort').value = port;
              document.getElementById('companyUser').value = user;
              document.getElementById('companyPassword').value = password;
              document.getElementById('companyTurma').value = turma;
              document.getElementById('companyId').value = id;
          }

          window.onclick = function(event) {
              const modal = document.getElementById('companyModal');
              if (event.target == modal) {
                  modal.style.display = 'none';
              }
          }
      </script>
  </main>
</div>
{% endblock %}

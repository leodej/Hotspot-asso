{% extends "base.html" %}

{% block page_title %}Dashboard - MikroTik Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
        <p class="text-muted">Visão geral do sistema</p>
    </div>
    
    <!-- Filtro por Empresa -->
    <div class="d-flex gap-2">
        <select class="form-select" onchange="filterByCompany(this.value)" style="width: 200px;">
            <option value="">Todas as Empresas</option>
            {% for company in companies %}
            <option value="{{ company.id }}" {{ 'selected' if company.id == selected_company }}>
                {{ company.name }}
            </option>
            {% endfor %}
        </select>
        <button class="btn btn-outline-primary" onclick="updateCredits()">
            <i class="bi bi-arrow-clockwise"></i> Atualizar
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-people text-primary" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ stats.total_users }}</h3>
                <p class="text-muted mb-0">Usuários Hotspot</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-building text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ stats.active_companies }}</h3>
                <p class="text-muted mb-0">Empresas Ativas</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-person-badge text-warning" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ stats.total_profiles }}</h3>
                <p class="text-muted mb-0">Perfis Hotspot</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="bi bi-credit-card text-info" style="font-size: 2rem;"></i>
                <h3 class="mt-2">{{ format_mb_to_gb(stats.total_credits_mb) }}</h3>
                <p class="text-muted mb-0">Créditos Disponíveis</p>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-activity"></i> Atividades Recentes</h5>
            </div>
            <div class="card-body">
                {% if activities %}
                    {% for activity in activities %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            <i class="bi bi-person-plus text-success"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">{{ activity.title }}</h6>
                            <small class="text-muted">{{ activity.description }}</small>
                            {% if activity.company_name %}
                            <span class="badge bg-light text-dark ms-2">{{ activity.company_name }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">Nenhuma atividade recente</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Sistema</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted">Status do Sistema</small>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">Online</span>
                        <small>Funcionando normalmente</small>
                    </div>
                </div>
                
                <div class="mb-3">
                    <small class="text-muted">Filtro Ativo</small>
                    <div>
                        <small>
                            {% if selected_company %}
                                {% for company in companies %}
                                    {% if company.id == selected_company %}
                                        {{ company.name }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                Todas as empresas
                            {% endif %}
                        </small>
                    </div>
                </div>
                
                <button class="btn btn-outline-primary btn-sm w-100" onclick="updateCredits()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar Créditos
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterByCompany(companyId) {
    const url = new URL(window.location);
    if (companyId) {
        url.searchParams.set('company_id', companyId);
    } else {
        url.searchParams.delete('company_id');
    }
    window.location.href = url.toString();
}

function updateCredits() {
    fetch('/api/update-credits', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Créditos atualizados com sucesso!');
            location.reload();
        } else {
            alert('Erro ao atualizar créditos: ' + data.message);
        }
    })
    .catch(error => {
        alert('Erro na requisição: ' + error);
    });
}
</script>
{% endblock %}
